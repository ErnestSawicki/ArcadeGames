<!DOCTYPE html>
<html lang="en">
<head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
</head>

<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<script>

var carPic = document.createElement("img");
var carPicLoaded = false;



var canvas;
var canvasContext;

const KEY_LEFT_ARROW = 37;
const KEY_RIGHT_ARROW = 39;
const KEY_UP_ARROW = 38;
const KEY_DOWN_ARROW = 40;

var keyHeld_Gas = false;
var keyHeld_Brake = false;
var keyHeld_TurnLeft = false;
var keyHeld_TurnRight = false;


var mouseX;
var mouseY;

function keyPressed(evt){
	//console.log("KeyPressed: "+evt.keyCode);
	if (evt.keyCode == KEY_LEFT_ARROW){
		keyHeld_TurnLeft = true;
	}
	if (evt.keyCode == KEY_RIGHT_ARROW){
		keyHeld_TurnRight = true;
	}
	if (evt.keyCode == KEY_UP_ARROW){
		keyHeld_Gas = true;
	}
	if (evt.keyCode == KEY_DOWN_ARROW){
		keyHeld_Brake = true;
	}
	evt.preventDefault();
}
function keyReleased(evt){
	//console.log("KeyReleased: "+evt.keyCode);
	if (evt.keyCode == KEY_LEFT_ARROW){
		keyHeld_TurnLeft = false;
	}
	if (evt.keyCode == KEY_RIGHT_ARROW){
		keyHeld_TurnRight = false;
	}
	if (evt.keyCode == KEY_UP_ARROW){
		keyHeld_Gas = false;
	}
	if (evt.keyCode == KEY_DOWN_ARROW){
		keyHeld_Brake = false;
	}
}

window.onload = function() {
	canvas = document.getElementById('gameCanvas');
	canvasContext = canvas.getContext('2d');
	
	var framesPerSecond = 30;
	setInterval(updateAll, 1000/framesPerSecond);
	canvas.addEventListener('mousemove', updateMousePos);
	
	document.addEventListener('keydown', keyPressed);
	document.addEventListener('keyup', keyReleased);
	
	carPic.onload = function(){
	 carPicLoaded = true;
	}
	carPic.src = "player1car.png";
	
	carReset();
	
}
function updateMousePos(evt){
	var rect = canvas.getBoundingClientRect();
	var root = document.documentElement;

	mouseX = evt.clientX - rect.left - root.scrollLeft;
	// for future Y value of mouse position
	mouseY = evt.clientY - rect.top - root.scrollTop;
	
	//cheat/ hack to test car in any position
	/*carX = mouseX;
	carY = mouseY;
	carSpeed = -3;
	carSpeed = -3;
	*/
	
}

//car var/constants
var carX = 75;
var carY = 75;
var carAngle = 3*Math.PI/2;
var carRadius = 10;
var carSpeed = 0;




const TRACK_WIDTH = 40;
const TRACK_HEIGHT = 40;
const TRACK_COLUMNS = 20;
const TRACK_ROWS = 15;
const TRACK_GAP = 3;

var trackGrid = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
				 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1,
				 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
				 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1,
				 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1,
				 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1,
				 1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
				 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
				 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
				 1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
				 1, 0, 2, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1,
				 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
				 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1,
				 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1,
				 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1];
				 
const TRACK_ROAD = 0;
const TRACK_WALL = 1;
const TRACK_PLAYERSTART = 2;

function updateAll(){
	moveAll();
	drawAll();
}

const GROUNDSPEED_DECAY_MULT = 0.94;
const DRIVE_POWER = 0.3
const BRAKES_POWER = 0.6;
const TRACTION = 0.1;
function carMove(){
	carSpeed *= GROUNDSPEED_DECAY_MULT;
	if (keyHeld_Gas && carSpeed < 5){
		carSpeed += DRIVE_POWER;
	}
	if (keyHeld_Brake && carSpeed > -1){
		carSpeed -= BRAKES_POWER;
	}
	if (keyHeld_TurnLeft){
		carAngle -= TRACTION;
	}
	if (keyHeld_TurnRight){
		carAngle += TRACTION;
	}
	carX += carSpeed * Math.cos(carAngle);
	carY += carSpeed * Math.sin(carAngle);
	
}
function carTrackHandling(){
	//tracks delete under car
	var carTrackCol = Math.floor(carX / TRACK_WIDTH);
	var carTrackRow = Math.floor(carY / TRACK_HEIGHT);
	var trackIntexUnderCar = rawColToArrayIntex(carTrackCol, carTrackRow);
	
	if(carTrackCol >= 0 && carTrackCol < TRACK_COLUMNS &&
	carTrackRow >= 0 && carTrackRow < TRACK_ROWS ){
		if (trackGrid[trackIntexUnderCar]){
			if (carSpeed > 0) {
				carSpeed -= 1;
			}
			if (carSpeed < 0) {
				carSpeed += 1;
			}
		} //end of trackIntexCheck, false assignment after colisiton, speedDirection change
	} //end of carWithin tracks space
} //end of carTrackHandling function

function moveAll(){
	carMove();
	carTrackHandling();
}

function carReset(){
	for (var eachRow = 0; eachRow < TRACK_ROWS; eachRow++){
		for (var eachCol = 0; eachCol < TRACK_COLUMNS; eachCol++){
			var arrayIndex = rawColToArrayIntex(eachCol, eachRow);
			if (trackGrid[arrayIndex] == TRACK_PLAYERSTART){
				trackGrid[arrayIndex] = TRACK_ROAD;
				carX = eachCol * TRACK_WIDTH + TRACK_WIDTH/2;
				carY = eachRow * TRACK_HEIGHT + TRACK_HEIGHT/2;
				} //end of is this track here
			
		} //end of for each track in column
	} // end of rows count
}

function drawAll(){
	//canvas background black
	colorRectangle("black", 0, 0, canvas.width, canvas.height);
	//car
	//colorCar("white", carX, carY, carRadius);
	if(carPicLoaded){
		drawBitmapCenteredWithRotation(carPic, carX, carY, carAngle);
	}
	//tracks
	drawTracks("blue");
	
	//mouseCoordinates
	//colorText("X:"  + mouseX + ", Y:" + mouseY, mouseX + 10, mouseY + 10, "red");
	var mouseTrackCol = Math.floor(mouseX / TRACK_WIDTH);
	var mouseTrackRow = Math.floor(mouseY / TRACK_HEIGHT);
	var trackIntexUnderMouse = rawColToArrayIntex(mouseTrackCol, mouseTrackRow);
	colorText(mouseTrackCol + ", " + mouseTrackRow + "; " + trackIntexUnderMouse, mouseX + 10, mouseY + 10, "red");


}


//auxilary draw functions

function drawBitmapCenteredWithRotation(useBitmap, atX,atY, withAng) {
	canvasContext.save();
	canvasContext.translate(atX, atY);
	canvasContext.rotate(withAng);
	canvasContext.drawImage(useBitmap, -useBitmap.width/2, -useBitmap.height/2);
	canvasContext.restore();
}

function colorRectangle(color, positionX, positionY, width, height){
	canvasContext.fillStyle = color;
	canvasContext.fillRect(positionX,positionY,width, height);
}
function colorCar(color, positionX, positionY, radius){
	canvasContext.fillStyle = color;
	canvasContext.beginPath();
	canvasContext.arc(positionX,positionY,radius,0,Math.PI*2, true);
	canvasContext.fill();
}


function rawColToArrayIntex(col, row){
	return col + TRACK_COLUMNS * row;
}
function drawTracks(color){

	canvasContext.fillStyle = color;
	for (var eachRow = 0; eachRow < TRACK_ROWS; eachRow++){
		for (var eachCol = 0; eachCol < TRACK_COLUMNS; eachCol++){
			var arrayIndex = rawColToArrayIntex(eachCol, eachRow);
			
			if (trackGrid[arrayIndex] == TRACK_WALL){
				canvasContext.fillRect(TRACK_WIDTH * eachCol, TRACK_HEIGHT * eachRow, TRACK_WIDTH - TRACK_GAP, TRACK_HEIGHT - TRACK_GAP);
			} //end of is this track here
			
		} //end of for each track in column
	} // end of rows count
} //end of drawTrack function

function colorText(showWords, textX,textY, fillColor){
	canvasContext.fillStyle = fillColor;
	canvasContext.fillText(showWords, textX, textY);
}

</script>
</body>
</html>